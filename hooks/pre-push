#! /bin/bash

set -euo pipefail

echo "Pre push checks running..."

# Compare version in HEAD vs current working tree
OLD_VERSION=$(git show HEAD:package.json 2>/dev/null | jq -r .version || echo "none")
NEW_VERSION=$(jq -r .version package.json)

if [[ "$OLD_VERSION" == "$NEW_VERSION" ]]; then
  echo "✖ Version has not changed (still $NEW_VERSION)."
  echo "→ Run 'npm version patch|minor|major' before pushing a release."
  exit 1
fi

npm run lint:check
if [ $? -ne 0 ]; then
  echo "Lint check failed"
  exit 1
fi

npm run prettier:check
if [ $? -ne 0 ]; then
  echo "Prettier check failed"
  exit 1
fi

npm run test
if [ $? -ne 0 ]; then
  echo "Tests failed"
  exit 1
fi

echo "✓ Version bumped: $OLD_VERSION → $NEW_VERSION"
