#! /bin/bash

set -euo pipefail

echo "Pre push checks running..."

# require jq
command -v jq >/dev/null || { echo "jq is required for version checks"; exit 1; }

# If there is no commit yet (brand new repo), skip
git rev-parse --verify HEAD >/dev/null 2>&1 || exit 0

# Only check if package.json is staged in this commit
if ! git diff --name-only --cached | grep -qx "package.json"; then
  exit 0
fi

# OLD = version in HEAD (last committed)
OLD_VERSION=$(git show HEAD:package.json 2>/dev/null | jq -r .version || echo "0.0.0")
# NEW = version in the INDEX (staged), not working tree
NEW_VERSION=$(git show :package.json | jq -r .version)

if [[ "$OLD_VERSION" == "$NEW_VERSION" ]]; then
  echo "✖ Version has not changed (still $NEW_VERSION)."
  echo "→ Run 'npm version patch|minor|major' before committing the release."
  exit 1
fi

echo "✓ Version bumped: $OLD_VERSION → $NEW_VERSION"
npm run lint:check
if [ $? -ne 0 ]; then
  echo "Lint check failed"
  exit 1
fi

npm run prettier:check
if [ $? -ne 0 ]; then
  echo "Prettier check failed"
  exit 1
fi

npm run test
if [ $? -ne 0 ]; then
  echo "Tests failed"
  exit 1
fi

echo "✓ Version bumped: $OLD_VERSION → $NEW_VERSION"
